% Compile with:
% latexmk -pdf -pvc -interaction=nonstopmode
%\documentclass[draft]{beamer}
\documentclass[final]{beamer}
\usetheme[color=screen]{UniBern}

%\setbeameroption{show notes}
%\includeonlyframes{current}

\usepackage{lmodern}
\usepackage[english]{babel}
\usepackage{microtype}
\usepackage{textcomp}
\usepackage[backend=biber, style=numeric, url=false, isbn=false, maxbibnames=1, sorting=none]{biblatex}
	\addbibresource{../../Documents/library.bib}
\usepackage{graphicx}
\usepackage{tikz}
	\usetikzlibrary{arrows.meta,shapes}
\usepackage[detect-all=true, range-phrase=--, range-units=single, binary-units=true]{siunitx}
\usepackage{csquotes}
\usepackage{animate}
\usepackage[absolute,overlay]{textpos} %for the \source{} command
\usepackage{gitinfo2}
\usepackage{ulem}
\usepackage{xspace}
\usepackage{textcomp} % for arrows
\usepackage{hyperref}

% Some often used abbreviations
\newcommand{\imsize}{\linewidth} % globally set image width
\newcommand{\everyframe}{1} % use only every nth frame for the movies
\newlength\imagewidth % needed for scalebars
\newlength\imagescale % needed for scalebars
\newcommand{\uct}{\si{\micro}CT\xspace} % make our life easier
\newcommand{\uaf}{\si{\micro}AngioFil\xspace} % make our life easier

% Easily fill a frame with the whole image.
% Based on http://tex.stackexchange.com/a/334758/828, http://tex.stackexchange.com/a/244103/828 and ubTitleHeight and ubFooterHeight found in the Unibe Beamer template.
\newcommand{\fullframeimage}[1]{%
	\begin{tikzpicture}[remember picture,overlay]%
		%\node[xshift=0,yshift=-0.085\paperheight-0.016\paperheight/2] at (current page.center){\includegraphics[width=\paperwidth]{#1}};%
		\node[xshift=0,yshift=0] at (current page.center){\includegraphics[width=\paperwidth]{#1}};%		
	\end{tikzpicture}%
}

% Acknowledge things in the lower right of the slide
% Based on http://tex.stackexchange.com/a/48485/828
\newcommand{\source}[1]{
	\begin{textblock*}{4cm}(8.7cm,8.6cm)%
		\begin{beamercolorbox}[ht=0.5cm,right]{framesource}%
			\tiny\usebeamerfont{framesource}\usebeamercolor[fg]{framesource} Source: {#1}%
		\end{beamercolorbox}%
	\end{textblock*}%
}

% define 'unibe' color
\definecolor{unibe}{RGB}{156,189,222}

%% Show current section at begin of sections
%\AtBeginSection[]{
%	\begin{frame}{Outline}
%	\small
%	\tableofcontents[currentsection, hideothersubsections]
%	\end{frame} 
%}

% Define us a custom footer
\defbeamertemplate{footline}{unibe}{%
	\usebeamercolor[fg]{page number in head/foot}%
	\usebeamerfont{page number in head/foot}%
	\hspace*{0.5cm}%
	\insertshortauthor\xspace|\xspace\insertshorttitle\xspace|\xspace Version \gitAbbrevHash%
	\hspace*{\fill}
	\insertframenumber\,/\,\inserttotalframenumber%
	\hspace*{0.5cm}%
	\vskip2pt%
}
\setbeamertemplate{footline}[unibe]

% Format bibliography for beamer
% http://tex.stackexchange.com/a/10686/828
\renewbibmacro{in:}{}
% http://tex.stackexchange.com/a/13076/828
% \AtEveryBibitem{\clearfield{title}}
\AtEveryBibitem{\clearfield{journaltitle}}
\AtEveryBibitem{\clearfield{pages}}
\AtEveryBibitem{\clearfield{volume}}
\AtEveryBibitem{\clearfield{number}}
\AtEveryBibitem{\clearfield{editors}}

% Subtitle and other informations
\title[Quantitative assessment of brain tumor vasculature]{Quantitative assessment of brain tumor radiation treatment reveals decrease in tumor-supporting vessels}
\author{David Haberthür}
\institute{Institute of Anatomy, University of Bern}
\date{July 13, 2017\\12\textsuperscript{th} microCT User Meeting}

\begin{document}
% We want no footline on the title page, http://tex.stackexchange.com/a/18829/828 helps
{%
	\setbeamertemplate{footline}{}%
	\begin{frame}%
		\maketitle
	\end{frame}%
}
\setcounter{framenumber}{0}

\title[Quantitative assessment of brain tumor vasculature]{Quantitative assessment of brain tumor radiation treatment reveals decrease in tumor-supporting vessel complexity}
{%
	\setbeamertemplate{footline}{}%
	\begin{frame}%
		\maketitle
	\end{frame}%
}
%\setcounter{framenumber}{0}

\begin{frame}
	\frametitle{Contents}
	\tableofcontents
\end{frame}

\section{Who's talking?}
\begin{frame}
	\frametitle{Who's talking?}
	\begin{itemize}
		\item<1-> University of Bern, Switzerland
		\item<1-> Institute of Anatomy
		\item<1-> Group for topographic and clinical Anatomy
		\item<1-> \uct-Team: Ruslan Hlushchuk, David Haberthür, 2 Students
		\only<2>{\fullframeimage{./img/vreni_rigth-eye_Flyer_6-56um__Contrast-BusinessCard_scalebar.pdf}}
		\item<3> SkyScan 1272 \& 1172
		\item<3> Biomedical research
	\end{itemize}
\end{frame}

\section{What's the problem \& why are the blood vessels so important?}
\begin{frame}
	\frametitle{What's the problem?}
	\begin{itemize}
		\item 57099 incidences of brain and central nervous system cancer in Europe in 2012 \cite{Ferlay2013}
		\item Malignant gliomas (brain tumors) constitute a major therapeutic problem because of extremely poor prognosis
		\item Gliomas make up \SI{30}{\percent} of all brain and central nervous system tumors as well as \SI{80}{\percent} of all malignant brain tumors \cite{Goodenberger2012}
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Why are blood vessels important?}
	\begin{itemize}
		\item Judah Folkman: \blockquote[\cite{Sherwood1971}]{Tumors that exist in the dormant state have not become vascularised.}
		\item Anti-Angiogenesis as tumor therapy
		\begin{itemize}
			\item \href{https://clinicaltrials.gov/ct2/results?term=antiangiogenic}{\textgreater4000 clinical trials}
			\item Results \only<1>{disappointing}\only<2>{unsatisfactory}
			\item New, powerful and simple treatment strategies are needed
		\end{itemize}
		\item Microbeam radiation therapy
		\begin{itemize}
			\item Delivery of very high dose (\SIrange{100}{5000}{\gray}) in less than \SI{1}{\second}.
			\item Excellent survival rate \cite{Laissue1998}
		\end{itemize}
	\end{itemize}
	\pause
	\pause
	\begin{tikzpicture}[remember picture,overlay]
		\node[xshift=6cm, yshift=-6cm, rotate=-45, fill=gray, opacity=0.618, text opacity=1] at (current page.north west) {\huge That's the hard part!};
	\end{tikzpicture}
\end{frame}

\begin{frame}
	\frametitle{Quantitative assessment}
	\begin{itemize}
		\item \emph{Problem:} Assessing radiation treatment.
		\begin{itemize}
			\item The tumor volume should decrease.
		\end{itemize}
		\pause
		\item \emph{Solution:} (\uct) 3D data \pause
		\begin{tikzpicture}[remember picture,overlay]
    		\node[xshift=8cm, yshift=-4cm, rotate=-45, fill=gray, opacity=0.618, text opacity=1] at (current page.north west) {\huge Easy!};
		\end{tikzpicture}
		\item[]	
		\pause	
		\item \emph{Problem} Intra-tumoral microvessel density (IMD)
		\begin{itemize}
			\item Standardized assessment of tumor angiogenesis~\cite{Hasan2002}.
				Usually done on Light microscopy slides, thus only available in 2D.
		\end{itemize}
		\pause
		\item \emph{Solution} (\uct) 3D data
		\pause
		\begin{tikzpicture}[remember picture,overlay]
		    \node[xshift=8cm, yshift=-7cm, rotate=-45, fill=gray, opacity=0.618, text opacity=1] at (current page.north west) {\huge A bit harder\ldots};
		\end{tikzpicture}
	\end{itemize}
\end{frame}

\section{How did we do it?}
\subsection{Animals}
\begin{frame}
	\frametitle{Rat brain tumors}
	\begin{columns}
		\begin{column}{0.48\linewidth}
			\begin{itemize}
				\item 9L Gliosarcoma \cite{Bouchet2014}
				\item Microbeam and broadbeam treatment vs.\ control at three time points
				\item \uaf-filled brain vasculature
				\item Nondestructive extraction of
				\begin{itemize}
					\item Vascular density
					\item Vessel surface
					\item Intra-tumoral microvessel density (IMD, \cite{Hasan2002})
				\end{itemize}
			\end{itemize}
		\end{column}
		\begin{column}{0.24\linewidth}
			\pgfmathsetlength{\imagewidth}{\imsize}%
			\pgfmathsetlength{\imagescale}{\imagewidth/299}%
			\def\x{185}% scalebar-x starting at golden ratio of image width of 299px = 185
			\def\y{460}% scalebar-y at 90% of image height of 546px = 491
			\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
				\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/{{macro_brain_d24_ctrl_backoff}}}};
				% 500px = 30.0mm > 100px = 6004um > 8px = 500um, 2px = 100um
				%\draw[|-|,blue,thick] (179,523) -- (121,27) node [sloped,midway,above,fill=white,semitransparent,text opacity=1] {\SI{30.0}{\milli\meter} (500px) TEMPORARY!};
				\draw[|-|, thick] (\x,\y) -- (\x+83,\y) node [midway,below] {\SI{5}{\milli\meter}};
				\pause
				\draw<2>[red, thick] (187,182) circle (50);
			\end{tikzpicture}%
		\end{column}%
		\begin{column}{0.24\linewidth}%
			\pgfmathsetlength{\imagewidth}{\imsize}%
			\pgfmathsetlength{\imagescale}{\imagewidth/299}%
			\def\x{185}% scalebar-x starting at golden ratio of image width of 299px = 185
			\def\y{460}% scalebar-y at 90% of image height of 511px = 460
			\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
				\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/{{macro_brain_d24_mrt_backoff}}}};
				% 463px = 30.0mm > 100px = 6478um > 8px = 500um, 2px = 100um
				%\draw[|-|,blue,thick] (163,479) -- (162,16) node [sloped,midway,above,fill=white,semitransparent,text opacity=1] {\SI{30.0}{\milli\meter} (463px) TEMPORARY!};
				\draw[|-|, thick] (\x,\y) -- (\x+77,\y) node [midway,below] {\SI{5}{\milli\meter}};
				\draw<2>[red, thick] (199,187) circle (50);
			\end{tikzpicture}%
		\end{column}
	\end{columns}
\end{frame}

\subsection{\uct}
\begin{frame}
	\frametitle{Scanning, Reconstruction \& Preparation}
	\begin{itemize}
		\item Scanning \& Reconstruction 
		\begin{itemize}
			\item SkyScan1272
			\item 4904 \(\times\) \SI{3280}{px}, \SI{0.1}{\degree} rotation step
			\item \SI{70}{\kilo\volt}, \SI{142}{\micro\ampere}, \SI{0.5}{\milli\meter} Al filter
			\item Pixel size \SI{5}{\micro\meter}
			\item Exposure \SI{3300}{\milli\second}, 3\(\times\) frame averaging, 3 connected scans
			\begin{itemize}
				\item \SI{\approx17}{\hour} scanning time per sample
				\item \SI{\approx40}{\day} of continuous scanning
				\item (partial) reconstructions: \SI{\approx1.8}{\tera\byte} of data
			\end{itemize}
			\item Tumor region reconstructed% (NRecon 1.7.0.4, GPUReconServer 1.7.0, Ring Artifact Correction=20, Beam Hardening Correction \SI{50}{\percent}, Hamming filter)
		\end{itemize}
		\item Preparation
		\begin{itemize}
			\item Tumor ROI delineated in CTAn 
			\item Exported to PNG slices
			\item Analysis pipeline written in \href{http://github.com/habi/grenoble-brains}{Python/Jupyter}
		\end{itemize}
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{3D view of one sample}%
	\begin{overprint}% Solve the jumping text problem https://tex.stackexchange.com/a/17947/828
		\begin{itemize}%
			\item Control%
			\item \SI{20}{\day} after tumor cell implantation%
			\item \SI{10}{\day} after brain extraction (no radiation treatment)%
		\end{itemize}%
		\onslide<2>
		\begin{tikzpicture}[remember picture,overlay]%
			\node[xshift=0,yshift=-0.085\paperheight-0.016\paperheight/2] at (current page.center){%
				\animategraphics[autoplay,width=\imsize,every=\everyframe]{24}{movies/TumorView_mov_small/b01_ctrl_d20t10_ir_rec00000}{001}{361}%
			};%
		\end{tikzpicture}%
	\end{overprint}	
\end{frame}

\subsection{Analysis}
\begin{frame}
	\frametitle{Image processing}
	\begin{columns}
		\begin{column}[T]{0.48\linewidth}
			\begin{itemize}
				\item<1-> ROI extraction
				\item<3-> Calculation of tumor area
				\item<4-> Thresholding to separate blood vessels
				\item<5-> Removal of \emph{big} structures
				\item<6-> Euclidean distance transformation
				\item<7-> Calculation of vessel surface
				\item<8-> Labelling/counting objects
			\end{itemize}
		\end{column}
		\begin{column}[T]{0.48\linewidth}
			\only<1>{%
				\pgfmathsetlength{\imagewidth}{\imsize}%
				\pgfmathsetlength{\imagescale}{\imagewidth/4228}%
				\def\x{2613}% scalebar-x starting at golden ratio of image width of 4228px = 2613
				\def\y{3805}% scalebar-y at 90% of image height of 4228px = 3805
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_rec00003856}}}};
					% 4228px = 21.14mm > 100px = 500um > 100px = 500um, 20px = 100um
					%\draw[|-|,blue,thick] (0,2114) -- (4228,2114) node [sloped,midway,above,fill=white,semitransparent,text opacity=1] {\SI{21.14}{\milli\meter} (4228px) TEMPORARY!};
					\draw[|-|,white,thick] (\x,\y) -- (\x+1000,\y) node [midway,above] {\SI{5}{\milli\meter}};
				\end{tikzpicture}%
				}
			\pgfmathsetlength{\imagewidth}{\imsize}%
			\pgfmathsetlength{\imagescale}{\imagewidth/740}%
			\def\x{457}% scalebar-x starting at golden ratio of image width of 740px = 457
			\def\y{527}% scalebar-y at 90% of image height of 586px = 527	
			\only<2>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{b65_bb_d20t10_rec0000_voi_1928}}}};
					% 740px = 3.7mm > 100px = 500um > 100px = 500um, 20px = 100um
					%\draw[|-|,blue,thick] (0,293) -- (740,293) node [sloped,midway,above,fill=white,semitransparent,text opacity=1] {\SI{3.7}{\milli\meter} (740px) TEMPORARY!};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<3>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_hull_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<4>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_threshold_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<5>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_cleaned_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<6>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_edt_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<7>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_surface_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}
			\only<8>{%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
					\node[anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {\includegraphics[width=\imagewidth]{./img/imageprocessing/{{B65_bb_D20T10_label_0143}}}};
					\draw[|-|,white,thick] (\x,\y) -- (\x+100,\y) node [midway,above] {\SI{500}{\micro\meter}};
				\end{tikzpicture}%
				}																					
		\end{column}
	\end{columns}
\end{frame}

%\begin{frame}
%	\frametitle{3D view: VOI}
%	\animategraphics[autoplay,palindrome,width=\imsize,every=\everyframe]{24}{movies/mov_roi/b65_bb_d20t10_rec0000_voi_0}{001}{241} % 241
%\end{frame}
%
%\begin{frame}
%	\frametitle{3D view: Thresholded}
%	\animategraphics[autoplay,palindrome,width=\imsize,every=\everyframe]{24}{movies/mov_threshold/b65_bb_d20t10_threshold_0}{001}{241} % 241
%\end{frame}
%
%\begin{frame}
%	\frametitle{3D view: Cleaned}
%	\animategraphics[autoplay,palindrome,width=\imsize,every=\everyframe]{24}{movies/mov_cleaned/b65_bb_d20t10_cleaned_0}{001}{241} % 241
%\end{frame}
%
%\begin{frame}
%	\frametitle{3D view: Overlay}
%	\animategraphics[autoplay,palindrome,width=\imsize,every=\everyframe]{24}{movies/mov_overlay/b65_bb_d20t10_threshold_0}{001}{241} % 241
%\end{frame}

\section{Results}
\renewcommand{\imsize}{0.9\linewidth}
\begin{frame}
	\frametitle{Tumor volume}
	\centering	
	\includegraphics<1>[width=\imsize]{img/talk_tumor_volume}
	\includegraphics<2>[width=\imsize]{img/talk_tumor_volume_day}	
\end{frame}

\begin{frame}
	\frametitle{Vessel volume per tumor volume}
	\centering	
	\includegraphics<1>[width=\imsize]{img/talk_vessel_ratio}
	\includegraphics<2>[width=\imsize]{img/talk_vessel_ratio_day}	
\end{frame}

\begin{frame}
	\frametitle{Vessel surface}
	\centering
	\includegraphics<1>[width=\imsize]{img/talk_surface}
	\includegraphics<2>[width=\imsize]{img/talk_surface_day}	
\end{frame}

\section{Summary}
\begin{frame}
	\frametitle{Summary}
	\begin{itemize}
		\item Radiation therapy reduces tumor \emph{micro}-vasculature
		\item Radiation therapy reduces vessel complexity (significantly smaller surface)
		\item[]
		\pause
		\item Sample preparation crucial
		\item High throughput scanning for prospective study
		\item Quantitative assessment of sample properties
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Thanks}
	\begin{itemize}
		\item Topographic and clinical Anatomy, namely
		\begin{itemize}
			\item Ruslan Hlushchuk
			\item Marine Potez
			\item Audrey Bouchet
			\item Valentin Djonov
		\end{itemize}
		\item ESRF Grenoble
		\item SNF
		\pause
		\item You, for listening
		\item[]
		\pause
		\item Questions?
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{References}
	\renewcommand*{\bibfont}{\scriptsize}
	%\renewcommand*{\bibfont}{\footnotesize}
	\setbeamertemplate{bibliography item}{\insertbiblabel}
	\printbibliography
\end{frame}

\end{document}